<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BoothPulse AI - Decision-Support Governance Command Center</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Leaflet.js CDN -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet MarkerCluster -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
    />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- Custom Tailwind Config -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              slate: {
                750: "#1e293b",
                850: "#0f172a",
              },
            },
            fontFamily: {
              inter: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>

    <style>
      * {
        font-family: "Inter", sans-serif;
      }

      body {
        background: linear-gradient(
          135deg,
          #0f172a 0%,
          #1e293b 50%,
          #0f172a 100%
        );
        min-height: 100vh;
      }

      /* ========== CARD STYLES ========== */
      .dashboard-card {
        background: rgba(30, 41, 59, 0.6);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(71, 85, 105, 0.5);
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease,
          border-color 0.2s ease;
      }

      .dashboard-card:hover {
        transform: scale(1.02);
        box-shadow: 0 8px 32px rgba(59, 130, 246, 0.15);
        border-color: rgba(59, 130, 246, 0.3);
      }

      .metric-card {
        background: rgba(30, 41, 59, 0.6);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(71, 85, 105, 0.5);
        border-radius: 1rem;
        padding: 1.25rem;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
        min-height: 110px;
      }

      .metric-card:hover {
        transform: scale(1.02);
        box-shadow: 0 8px 32px rgba(59, 130, 246, 0.15);
      }

      /* ========== CRITICAL GLOW ========== */
      .critical-glow {
        animation: critical-pulse 2s infinite;
        border-color: rgba(239, 68, 68, 0.5) !important;
      }

      @keyframes critical-pulse {
        0%,
        100% {
          box-shadow:
            0 0 20px rgba(239, 68, 68, 0.3),
            0 4px 24px rgba(0, 0, 0, 0.2);
        }
        50% {
          box-shadow:
            0 0 40px rgba(239, 68, 68, 0.6),
            0 4px 24px rgba(0, 0, 0, 0.2);
        }
      }

      /* ========== MAP CONTAINER ========== */
      #map {
        height: 400px;
        border-radius: 0.75rem;
        z-index: 1;
      }

      /* ========== SCROLLBAR ========== */
      .custom-scroll::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scroll::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 3px;
      }
      .custom-scroll::-webkit-scrollbar-thumb {
        background: rgba(59, 130, 246, 0.5);
        border-radius: 3px;
      }
      .custom-scroll::-webkit-scrollbar-thumb:hover {
        background: rgba(59, 130, 246, 0.7);
      }

      /* ========== ANIMATIONS ========== */
      @keyframes fade-in {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .fade-in {
        animation: fade-in 0.5s ease-out;
      }

      @keyframes slide-in-right {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      .slide-in-right {
        animation: slide-in-right 0.3s ease-out;
      }

      @keyframes bounce-up {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-5px);
        }
      }
      @keyframes bounce-down {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(5px);
        }
      }
      .bounce-up {
        animation: bounce-up 1s ease-in-out infinite;
      }
      .bounce-down {
        animation: bounce-down 1s ease-in-out infinite;
      }

      @keyframes pulse-glow {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }
        50% {
          box-shadow: 0 0 40px rgba(239, 68, 68, 0.8);
        }
      }
      .pulse-glow {
        animation: pulse-glow 2s infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top-color: #3b82f6;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }

      @keyframes rotate {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      .refresh-spin {
        animation: rotate 1s linear infinite;
      }

      /* ========== GAUGE ========== */
      .gauge-container {
        position: relative;
        width: 180px;
        height: 100px;
        margin: 0 auto;
      }
      .gauge-bg {
        fill: none;
        stroke: rgba(255, 255, 255, 0.1);
        stroke-width: 20;
      }
      .gauge-fill {
        fill: none;
        stroke-width: 20;
        stroke-linecap: round;
        transition:
          stroke-dashoffset 1s ease-in-out,
          stroke 0.5s ease;
      }

      /* ========== SENTIMENT BADGES ========== */
      .badge-positive {
        background: linear-gradient(135deg, #10b981, #34d399);
      }
      .badge-negative {
        background: linear-gradient(135deg, #ef4444, #f87171);
      }
      .badge-neutral {
        background: linear-gradient(135deg, #6b7280, #9ca3af);
      }

      /* ========== ALERT SEVERITY ========== */
      .alert-high {
        border-left: 4px solid #ef4444;
        background: rgba(239, 68, 68, 0.1);
      }
      .alert-medium {
        border-left: 4px solid #f59e0b;
        background: rgba(245, 158, 11, 0.1);
      }
      .alert-low {
        border-left: 4px solid #10b981;
        background: rgba(16, 185, 129, 0.1);
      }

      /* ========== HEADER ========== */
      .sticky-header {
        position: sticky;
        top: 0;
        z-index: 50;
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
      }

      /* ========== SELECT STYLING ========== */
      select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
        background-color: #1e293b !important;
        color: white !important;
      }
      select option {
        background-color: #1e293b !important;
        color: white !important;
        padding: 10px;
      }
      select:focus {
        background-color: #1e293b !important;
        outline: none;
        ring: 2px;
        ring-color: #3b82f6;
      }

      /* ========== TABLE STYLES ========== */
      .table-row-striped:nth-child(even) {
        background: rgba(255, 255, 255, 0.02);
      }
      .table-row-striped:hover {
        background: rgba(59, 130, 246, 0.1);
      }

      /* ========== STATUS BADGES ========== */
      @keyframes status-pulse-red {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
        }
        50% {
          box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
        }
      }
      @keyframes status-pulse-yellow {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
        }
        50% {
          box-shadow: 0 0 0 8px rgba(245, 158, 11, 0);
        }
      }
      .status-critical {
        animation: status-pulse-red 2s infinite;
      }
      .status-watchlist {
        animation: status-pulse-yellow 2s infinite;
      }

      /* ========== DIVIDER ========== */
      .section-divider {
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(71, 85, 105, 0.5),
          transparent
        );
        margin: 2rem 0;
      }

      /* ========== LINE CLAMP ========== */
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      /* ========== CHART TRANSITIONS ========== */
      canvas {
        transition: opacity 0.5s ease;
      }
    </style>
  </head>

  <body class="text-white antialiased">
    <!-- ==================== HEADER ==================== -->
    <header class="sticky-header bg-slate-900/90 border-b border-slate-700/50">
      <div class="max-w-7xl mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
          <!-- Left: Logo + Title -->
          <div class="flex items-center space-x-4">
            <div
              class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg shadow-blue-500/25"
            >
              <svg
                class="w-7 h-7 text-white"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                />
              </svg>
            </div>
            <div>
              <div class="flex items-center space-x-3">
                <h1 class="text-2xl font-bold text-white">BoothPulse AI</h1>
                <span
                  class="px-2 py-0.5 text-xs font-semibold bg-emerald-500/20 border border-emerald-500/50 rounded-md text-emerald-400"
                  >v4.0 SQL</span
                >
              </div>
              <p class="text-sm text-slate-400">
                Decision-Support Governance Command Center
              </p>
            </div>
          </div>

          <!-- Right: Controls -->
          <div class="flex items-center space-x-4">
            <!-- Time Filter -->
            <div class="flex items-center space-x-2">
              <span class="text-xs text-slate-400">Time Range:</span>
              <select
                id="time-filter"
                class="px-3 py-1.5 text-sm border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500"
                onchange="onTimeFilterChange()"
              >
                <option value="all">All Time</option>
                <option value="1h">Last 1 Hour</option>
                <option value="24h">Last 24 Hours</option>
                <option value="7d">Last 7 Days</option>
              </select>
            </div>

            <!-- Export Button -->
            <button
              onclick="exportReport()"
              class="flex items-center space-x-2 px-4 py-2 bg-blue-500/20 border border-blue-500/50 rounded-lg hover:bg-blue-500/30 transition-all duration-200 text-sm font-medium text-blue-400"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                />
              </svg>
              <span>Export</span>
            </button>

            <!-- Refresh Indicator -->
            <div
              id="refresh-indicator"
              class="flex items-center space-x-2 text-xs text-slate-400"
            >
              <svg
                id="refresh-icon"
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                />
              </svg>
              <span id="last-refresh">--</span>
            </div>

            <!-- Early Warning Badge -->
            <div id="early-warning-badge" class="hidden">
              <span
                class="flex items-center space-x-2 px-4 py-2 bg-red-500/20 border border-red-500 text-red-400 rounded-full font-semibold text-sm shadow-lg shadow-red-500/40 animate-pulse"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                  />
                </svg>
                <span>Early Warning Active</span>
              </span>
            </div>

            <!-- Alert Counter -->
            <button
              onclick="toggleAlertCenter()"
              class="relative p-2 rounded-lg bg-slate-700/50 hover:bg-slate-700 transition-all duration-200"
            >
              <svg
                class="w-6 h-6 text-slate-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                />
              </svg>
              <span
                id="alert-badge"
                class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-xs flex items-center justify-center font-bold"
                >0</span
              >
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- ==================== MAIN CONTENT ==================== -->
    <main class="max-w-7xl mx-auto px-6 py-6 space-y-6">
      <!-- ==================== METRICS ROW ==================== -->
      <section>
        <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-6 gap-4">
          <!-- Total Feedback -->
          <div class="metric-card">
            <div class="flex items-center justify-between h-full">
              <div>
                <p class="text-sm text-slate-400 font-medium">Total Feedback</p>
                <p
                  id="total-feedback"
                  class="text-3xl font-bold text-white mt-1"
                >
                  0
                </p>
                <p
                  class="text-xs text-cyan-400 mt-1 flex items-center space-x-1"
                >
                  <svg
                    class="w-3 h-3"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"
                    />
                  </svg>
                  <span><span id="db-entries">0</span> in DB</span>
                </p>
              </div>
              <div
                class="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center flex-shrink-0"
              >
                <svg
                  class="w-6 h-6 text-blue-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"
                  />
                </svg>
              </div>
            </div>
          </div>

          <!-- Positive -->
          <div class="metric-card">
            <div class="flex items-center justify-between h-full">
              <div>
                <p class="text-sm text-slate-400 font-medium">Positive</p>
                <p
                  id="positive-pct"
                  class="text-3xl font-bold text-emerald-400 mt-1"
                >
                  0%
                </p>
              </div>
              <div
                class="w-12 h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center flex-shrink-0"
              >
                <svg
                  class="w-6 h-6 text-emerald-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </div>
            </div>
          </div>

          <!-- Negative -->
          <div class="metric-card">
            <div class="flex items-center justify-between h-full">
              <div>
                <p class="text-sm text-slate-400 font-medium">Negative</p>
                <p
                  id="negative-pct"
                  class="text-3xl font-bold text-red-400 mt-1"
                >
                  0%
                </p>
              </div>
              <div
                class="w-12 h-12 rounded-xl bg-red-500/20 flex items-center justify-center flex-shrink-0"
              >
                <svg
                  class="w-6 h-6 text-red-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </div>
            </div>
          </div>

          <!-- Neutral -->
          <div class="metric-card">
            <div class="flex items-center justify-between h-full">
              <div>
                <p class="text-sm text-slate-400 font-medium">Neutral</p>
                <p
                  id="neutral-pct"
                  class="text-3xl font-bold text-slate-400 mt-1"
                >
                  0%
                </p>
              </div>
              <div
                class="w-12 h-12 rounded-xl bg-slate-500/20 flex items-center justify-center flex-shrink-0"
              >
                <svg
                  class="w-6 h-6 text-slate-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 12h.01M12 12h.01M16 12h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </div>
            </div>
          </div>

          <!-- Risk Index -->
          <div class="metric-card" id="risk-card">
            <div class="flex items-center justify-between h-full">
              <div>
                <p class="text-sm text-slate-400 font-medium">Risk Index</p>
                <p
                  id="risk-index-value"
                  class="text-3xl font-bold text-yellow-400 mt-1"
                >
                  0
                </p>
              </div>
              <div
                class="w-12 h-12 rounded-xl bg-yellow-500/20 flex items-center justify-center flex-shrink-0"
              >
                <svg
                  class="w-6 h-6 text-yellow-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 10V3L4 14h7v7l9-11h-7z"
                  />
                </svg>
              </div>
            </div>
          </div>

          <!-- Momentum -->
          <div class="metric-card">
            <div class="flex items-center justify-between h-full">
              <div>
                <p class="text-sm text-slate-400 font-medium">Momentum</p>
                <div class="flex items-center space-x-2 mt-1">
                  <span id="momentum-arrow" class="text-2xl">â†’</span>
                  <span
                    id="momentum-value"
                    class="text-xl font-bold text-slate-400"
                    >Stable</span
                  >
                </div>
              </div>
              <div
                id="momentum-icon-container"
                class="w-12 h-12 rounded-xl bg-slate-500/20 flex items-center justify-center flex-shrink-0"
              >
                <svg
                  id="momentum-icon"
                  class="w-6 h-6 text-slate-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"
                  />
                </svg>
              </div>
            </div>
          </div>
        </div>
      </section>

      <div class="section-divider"></div>

      <!-- ==================== MAIN GRID: INPUT + ANALYTICS ==================== -->
      <section>
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
          <!-- Left Column: Input Form -->
          <div class="xl:col-span-1">
            <div class="dashboard-card h-full">
              <h2
                class="flex items-center space-x-2 text-lg font-semibold text-white mb-4"
              >
                <svg
                  class="w-5 h-5 text-blue-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                  />
                </svg>
                <span>Geo-Intelligent Input</span>
              </h2>

              <form id="feedback-form" class="space-y-4">
                <!-- Feedback Text -->
                <div>
                  <label class="block text-sm font-medium text-slate-300 mb-2"
                    >Public Feedback</label
                  >
                  <textarea
                    id="feedback-text"
                    rows="3"
                    class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none transition-all"
                    placeholder="Enter feedback... (e.g., 'Water supply is irregular in our area')"
                  ></textarea>
                </div>

                <!-- Country -->
                <div>
                  <label class="block text-sm font-medium text-slate-300 mb-2"
                    >Country</label
                  >
                  <select
                    id="country-select"
                    class="w-full px-4 py-2.5 border border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all cursor-pointer"
                  >
                    <option value="">Select Country</option>
                  </select>
                </div>

                <!-- State -->
                <div>
                  <label class="block text-sm font-medium text-slate-300 mb-2"
                    >State/Province</label
                  >
                  <select
                    id="state-select"
                    class="w-full px-4 py-2.5 border border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all cursor-pointer"
                    disabled
                  >
                    <option value="">Select State</option>
                  </select>
                </div>

                <!-- City -->
                <div>
                  <label class="block text-sm font-medium text-slate-300 mb-2"
                    >City</label
                  >
                  <select
                    id="city-select"
                    class="w-full px-4 py-2.5 border border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all cursor-pointer"
                    disabled
                  >
                    <option value="">Select City</option>
                  </select>
                </div>

                <!-- Manual Location Toggle -->
                <div>
                  <button
                    type="button"
                    onclick="toggleManualLocation()"
                    class="text-sm text-blue-400 hover:text-blue-300 flex items-center space-x-2 transition-all"
                  >
                    <svg
                      id="manual-toggle-icon"
                      class="w-4 h-4 transition-transform"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M19 9l-7 7-7-7"
                      />
                    </svg>
                    <span>Advanced Location Input (Optional)</span>
                  </button>
                </div>

                <!-- Manual Location Fields (Hidden by default) -->
                <div
                  id="manual-location"
                  class="hidden space-y-4 pt-4 border-t border-slate-600/50"
                >
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label
                        class="block text-xs font-medium text-slate-400 mb-1"
                        >Street Name</label
                      >
                      <input
                        type="text"
                        id="street-input"
                        class="w-full px-3 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white text-sm placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                        placeholder="Street name"
                      />
                    </div>
                    <div>
                      <label
                        class="block text-xs font-medium text-slate-400 mb-1"
                        >Landmark</label
                      >
                      <input
                        type="text"
                        id="landmark-input"
                        class="w-full px-3 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white text-sm placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                        placeholder="Near landmark"
                      />
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label
                        class="block text-xs font-medium text-slate-400 mb-1"
                        >Ward</label
                      >
                      <input
                        type="text"
                        id="ward-input"
                        class="w-full px-3 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white text-sm placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                        placeholder="Ward number"
                      />
                    </div>
                    <div>
                      <label
                        class="block text-xs font-medium text-slate-400 mb-1"
                        >Booth Number</label
                      >
                      <input
                        type="text"
                        id="booth-input"
                        class="w-full px-3 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white text-sm placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                        placeholder="Booth #"
                      />
                    </div>
                  </div>
                  <button
                    type="button"
                    onclick="resolveGeoLocation()"
                    class="w-full py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-sm text-slate-300 hover:bg-slate-700 transition-all flex items-center justify-center space-x-2"
                  >
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                      />
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                      />
                    </svg>
                    <span>Auto-Resolve Coordinates</span>
                  </button>
                  <div
                    id="geo-status"
                    class="hidden text-xs text-center py-2 rounded-lg"
                  ></div>
                </div>

                <!-- Submit Button -->
                <button
                  type="submit"
                  id="submit-btn"
                  class="w-full py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all duration-200 flex items-center justify-center space-x-2 shadow-lg shadow-blue-500/25"
                >
                  <span id="submit-text">Analyze Sentiment</span>
                  <div id="submit-spinner" class="hidden spinner"></div>
                </button>
              </form>

              <!-- Result Display -->
              <div
                id="result-container"
                class="hidden mt-6 pt-6 border-t border-slate-600/50 fade-in"
              >
                <h3
                  class="flex items-center space-x-2 font-semibold text-white mb-3"
                >
                  <svg
                    class="w-5 h-5 text-blue-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  <span>Analysis Result</span>
                </h3>
                <div id="result-card" class="rounded-xl p-4 text-white">
                  <div class="flex items-center justify-between mb-3">
                    <span
                      id="result-sentiment"
                      class="text-lg font-bold uppercase px-3 py-1 rounded-lg"
                    ></span>
                    <span
                      id="result-confidence"
                      class="text-sm opacity-80 bg-white/10 px-2 py-1 rounded"
                    ></span>
                  </div>
                  <div class="text-sm space-y-2 text-slate-200">
                    <p class="flex items-center space-x-2">
                      <svg
                        class="w-4 h-4 text-slate-400"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"
                        />
                      </svg>
                      <strong>Issue:</strong><span id="result-issue"></span>
                    </p>
                    <p class="flex items-center space-x-2">
                      <svg
                        class="w-4 h-4 text-slate-400"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                        />
                      </svg>
                      <strong>Location:</strong
                      ><span id="result-location"></span>
                    </p>
                    <p class="flex items-center space-x-2">
                      <svg
                        class="w-4 h-4 text-slate-400"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                      <strong>Time:</strong><span id="result-time"></span>
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column: Analytics -->
          <div class="xl:col-span-2 space-y-6">
            <!-- Risk Gauge + AI Summary Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Sentiment Risk Gauge -->
              <div class="dashboard-card">
                <h3
                  class="flex items-center space-x-2 text-lg font-semibold text-white mb-4"
                >
                  <svg
                    class="w-5 h-5 text-yellow-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M13 10V3L4 14h7v7l9-11h-7z"
                    />
                  </svg>
                  <span>Sentiment Risk Index</span>
                </h3>
                <div class="gauge-container">
                  <svg viewBox="0 0 200 120" class="w-full">
                    <path
                      class="gauge-bg"
                      d="M 20 100 A 80 80 0 0 1 180 100"
                    ></path>
                    <path
                      id="gauge-fill"
                      class="gauge-fill"
                      d="M 20 100 A 80 80 0 0 1 180 100"
                      stroke="#10b981"
                      stroke-dasharray="251.2"
                      stroke-dashoffset="251.2"
                    ></path>
                  </svg>
                  <div
                    class="absolute inset-0 flex items-end justify-center pb-2"
                  >
                    <span id="gauge-value" class="text-4xl font-bold text-white"
                      >0</span
                    >
                  </div>
                </div>
                <div
                  class="flex justify-between text-xs text-slate-400 mt-2 px-4"
                >
                  <span class="text-emerald-400">Safe (0-30)</span>
                  <span class="text-yellow-400">Caution (31-60)</span>
                  <span class="text-red-400">Critical (61-100)</span>
                </div>
              </div>

              <!-- AI Intelligence Summary -->
              <div class="dashboard-card">
                <h3
                  class="flex items-center space-x-2 text-lg font-semibold text-white mb-4"
                >
                  <svg
                    class="w-5 h-5 text-purple-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                    />
                  </svg>
                  <span>AI Intelligence Briefing</span>
                </h3>
                <div
                  id="ai-summary"
                  class="text-sm text-slate-300 leading-relaxed custom-scroll max-h-48 overflow-y-auto space-y-3"
                >
                  <p class="text-slate-500 italic">
                    No analysis data yet. Submit feedback to generate
                    intelligence insights.
                  </p>
                </div>
              </div>
            </div>

            <!-- Activity Feed -->
            <div class="dashboard-card">
              <h3
                class="flex items-center space-x-2 text-lg font-semibold text-white mb-4"
              >
                <svg
                  class="w-5 h-5 text-blue-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 10V3L4 14h7v7l9-11h-7z"
                  />
                </svg>
                <span>Live Activity Feed</span>
              </h3>
              <div
                id="activity-feed"
                class="custom-scroll max-h-48 overflow-y-auto space-y-3"
              >
                <p class="text-slate-500 italic text-center py-8">
                  No feedback submitted yet. Start by submitting your first
                  feedback!
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <div class="section-divider"></div>

      <!-- ==================== CHARTS SECTION ==================== -->
      <section>
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
          <!-- Sentiment Timeline -->
          <div class="dashboard-card">
            <h3
              class="flex items-center space-x-2 text-lg font-semibold text-white mb-4"
            >
              <svg
                class="w-5 h-5 text-blue-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"
                />
              </svg>
              <span>Sentiment Timeline</span>
            </h3>
            <div class="min-h-[200px]">
              <canvas id="timeline-chart"></canvas>
            </div>
          </div>

          <!-- Issue Density -->
          <div class="dashboard-card">
            <h3
              class="flex items-center space-x-2 text-lg font-semibold text-white mb-4"
            >
              <svg
                class="w-5 h-5 text-orange-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                />
              </svg>
              <span>Issue Density</span>
            </h3>
            <div class="min-h-[200px]">
              <canvas id="issue-chart"></canvas>
            </div>
          </div>

          <!-- Sentiment Distribution -->
          <div class="dashboard-card">
            <h3
              class="flex items-center space-x-2 text-lg font-semibold text-white mb-4"
            >
              <svg
                class="w-5 h-5 text-pink-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"
                />
              </svg>
              <span>Sentiment Distribution</span>
            </h3>
            <div class="min-h-[200px]">
              <canvas id="sentiment-chart"></canvas>
            </div>
          </div>
        </div>
      </section>

      <div class="section-divider"></div>

      <!-- ==================== GOVERNANCE ACTION ENGINE ==================== -->
      <section>
        <div class="dashboard-card" id="governance-engine">
          <h3
            class="flex items-center space-x-2 text-lg font-semibold text-white mb-4"
          >
            <svg
              class="w-5 h-5 text-amber-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
              />
            </svg>
            <span>Governance Action Engine</span>
          </h3>
          <div id="governance-actions" class="space-y-4">
            <div class="text-center py-8 text-slate-500 italic">
              <p>No governance actions required at this time.</p>
              <p class="text-xs mt-2">
                Actions will appear when issue thresholds are exceeded.
              </p>
            </div>
          </div>
        </div>
      </section>

      <div class="section-divider"></div>

      <!-- ==================== MAP SECTION ==================== -->
      <section>
        <div class="dashboard-card">
          <h3
            class="flex items-center space-x-2 text-lg font-semibold text-white mb-4"
          >
            <svg
              class="w-5 h-5 text-emerald-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
              />
            </svg>
            <span>Geo-Intensity Map</span>
            <span class="text-xs text-slate-400 ml-2"
              >(Clustered by sentiment intensity)</span
            >
          </h3>
          <div class="rounded-xl overflow-hidden border border-slate-700">
            <div id="map" style="height: 400px"></div>
          </div>
          <div class="flex justify-center space-x-6 mt-4 text-sm">
            <div class="flex items-center space-x-2">
              <div class="w-4 h-4 rounded-full bg-emerald-500"></div>
              <span class="text-slate-400">Positive</span>
            </div>
            <div class="flex items-center space-x-2">
              <div class="w-4 h-4 rounded-full bg-red-500"></div>
              <span class="text-slate-400">Negative</span>
            </div>
            <div class="flex items-center space-x-2">
              <div class="w-4 h-4 rounded-full bg-slate-500"></div>
              <span class="text-slate-400">Neutral</span>
            </div>
          </div>
        </div>
      </section>

      <div class="section-divider"></div>

      <!-- ==================== CITY RISK LEADERBOARD ==================== -->
      <section>
        <div class="dashboard-card">
          <h3
            class="flex items-center space-x-2 text-lg font-semibold text-white mb-4"
          >
            <svg
              class="w-5 h-5 text-cyan-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
              />
            </svg>
            <span>City Risk Leaderboard</span>
          </h3>
          <div class="overflow-x-auto custom-scroll">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-slate-400 border-b border-slate-600">
                  <th class="text-left px-4 py-3">Rank</th>
                  <th class="text-left px-4 py-3">City</th>
                  <th class="text-center px-4 py-3">Risk Score</th>
                  <th class="text-center px-4 py-3">Status</th>
                  <th class="text-center px-4 py-3">Total</th>
                  <th class="text-center px-4 py-3">Negative %</th>
                </tr>
              </thead>
              <tbody id="city-stats-body">
                <tr>
                  <td
                    colspan="6"
                    class="text-center py-8 text-slate-500 italic"
                  >
                    No city data available
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <!-- ==================== ALERT CENTER SIDEBAR ==================== -->
    <div
      id="alert-center"
      class="fixed top-0 right-0 w-96 h-full bg-slate-900/95 backdrop-blur-xl border-l border-slate-700 transform translate-x-full transition-transform duration-300 z-50 overflow-hidden"
    >
      <div class="h-full flex flex-col">
        <div class="p-6 border-b border-slate-700">
          <div class="flex items-center justify-between">
            <h2
              class="flex items-center space-x-2 text-xl font-bold text-white"
            >
              <svg
                class="w-6 h-6 text-red-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                />
              </svg>
              <span>Alert Center</span>
            </h2>
            <button
              onclick="toggleAlertCenter()"
              class="p-2 hover:bg-slate-700 rounded-lg transition-all"
            >
              <svg
                class="w-5 h-5 text-slate-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>

          <!-- Alert Stats -->
          <div class="grid grid-cols-3 gap-3 mt-4">
            <div class="bg-red-500/20 rounded-lg p-3 text-center">
              <p id="alert-high" class="text-2xl font-bold text-red-400">0</p>
              <p class="text-xs text-slate-400">High</p>
            </div>
            <div class="bg-yellow-500/20 rounded-lg p-3 text-center">
              <p id="alert-medium" class="text-2xl font-bold text-yellow-400">
                0
              </p>
              <p class="text-xs text-slate-400">Medium</p>
            </div>
            <div class="bg-emerald-500/20 rounded-lg p-3 text-center">
              <p id="alert-low" class="text-2xl font-bold text-emerald-400">
                0
              </p>
              <p class="text-xs text-slate-400">Low</p>
            </div>
          </div>
        </div>

        <!-- Alert List -->
        <div
          id="alert-list"
          class="flex-1 overflow-y-auto custom-scroll p-4 space-y-3"
        >
          <p class="text-slate-500 italic text-center py-8">No alerts yet</p>
        </div>
      </div>
    </div>

    <!-- Overlay for Alert Center -->
    <div
      id="alert-overlay"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden"
      onclick="toggleAlertCenter()"
    ></div>

    <!-- ==================== JAVASCRIPT ==================== -->
    <script>
      // ==================== GLOBAL STATE ====================
      let geoData = {};
      let resolvedCoordinates = null;
      let map = null;
      let markerCluster = null;
      let timelineChart = null;
      let issueChart = null;
      let sentimentChart = null;
      let currentTimeRange = "all";
      let cityMarkers = {};

      // ==================== INITIALIZATION ====================
      document.addEventListener("DOMContentLoaded", async () => {
        await loadGeoData();
        initMap();
        initCharts();
        loadDashboardData();
        loadAlerts();
        loadAISummary();
        updateRefreshTime();

        // Auto-refresh every 30 seconds
        setInterval(() => {
          loadDashboardData();
          loadAlerts();
          loadAISummary();
          updateRefreshTime();
        }, 30000);
      });

      function updateRefreshTime() {
        const now = new Date();
        document.getElementById("last-refresh").textContent =
          now.toLocaleTimeString();
      }

      function onTimeFilterChange() {
        currentTimeRange = document.getElementById("time-filter").value;
        document.getElementById("refresh-icon").classList.add("refresh-spin");
        loadDashboardData().then(() => {
          document
            .getElementById("refresh-icon")
            .classList.remove("refresh-spin");
        });
        loadAISummary();
      }

      async function exportReport() {
        try {
          const response = await fetch("/export-report");
          const data = await response.json();

          const blob = new Blob([JSON.stringify(data, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `boothpulse_report_${new Date().toISOString().slice(0, 10)}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          showNotification(
            "ðŸ“¥ Intelligence report exported successfully!",
            "info",
          );
        } catch (error) {
          console.error("Export error:", error);
          showNotification("Failed to export report", "error");
        }
      }

      // ==================== GEO DATA FUNCTIONS ====================
      async function loadGeoData() {
        try {
          const response = await fetch("/geo-data");
          geoData = await response.json();
          populateCountries();
        } catch (error) {
          console.error("Error loading geo data:", error);
        }
      }

      function populateCountries() {
        const countrySelect = document.getElementById("country-select");
        countrySelect.innerHTML = '<option value="">Select Country</option>';

        geoData.countries.forEach((country) => {
          const option = document.createElement("option");
          option.value = country;
          option.textContent = country;
          if (country === "India") option.selected = true;
          countrySelect.appendChild(option);
        });

        countrySelect.addEventListener("change", onCountryChange);

        // Trigger initial state load for India
        if (countrySelect.value) {
          onCountryChange();
        }
      }

      function onCountryChange() {
        const country = document.getElementById("country-select").value;
        const stateSelect = document.getElementById("state-select");
        const citySelect = document.getElementById("city-select");

        stateSelect.innerHTML = '<option value="">Select State</option>';
        citySelect.innerHTML = '<option value="">Select City</option>';
        citySelect.disabled = true;

        if (country && geoData.states_by_country[country]) {
          stateSelect.disabled = false;
          geoData.states_by_country[country].forEach((state) => {
            const option = document.createElement("option");
            option.value = state;
            option.textContent = state;
            stateSelect.appendChild(option);
          });
          stateSelect.addEventListener("change", onStateChange);
        } else {
          stateSelect.disabled = true;
        }
      }

      function onStateChange() {
        const state = document.getElementById("state-select").value;
        const citySelect = document.getElementById("city-select");

        citySelect.innerHTML = '<option value="">Select City</option>';

        if (state && geoData.cities_by_state[state]) {
          citySelect.disabled = false;
          geoData.cities_by_state[state].forEach((city) => {
            const option = document.createElement("option");
            option.value = city;
            option.textContent = city;
            citySelect.appendChild(option);
          });
        } else {
          citySelect.disabled = true;
        }
      }

      // ==================== MANUAL LOCATION ====================
      function toggleManualLocation() {
        const container = document.getElementById("manual-location");
        const icon = document.getElementById("manual-toggle-icon");

        if (container.classList.contains("hidden")) {
          container.classList.remove("hidden");
          icon.style.transform = "rotate(180deg)";
        } else {
          container.classList.add("hidden");
          icon.style.transform = "rotate(0deg)";
        }
      }

      async function resolveGeoLocation() {
        const street = document.getElementById("street-input").value;
        const landmark = document.getElementById("landmark-input").value;
        const city = document.getElementById("city-select").value;
        const state = document.getElementById("state-select").value;
        const country = document.getElementById("country-select").value;

        const statusDiv = document.getElementById("geo-status");
        statusDiv.classList.remove("hidden");
        statusDiv.className =
          "text-xs text-center py-2 rounded-lg bg-blue-500/20 text-blue-400";
        statusDiv.textContent = "Resolving coordinates...";

        if (!city || !state || !country) {
          statusDiv.className =
            "text-xs text-center py-2 rounded-lg bg-yellow-500/20 text-yellow-400";
          statusDiv.textContent =
            "Please select country, state, and city first";
          return;
        }

        try {
          const query = [street, landmark, city, state, country]
            .filter(Boolean)
            .join(", ");
          const response = await fetch(
            `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`,
            { headers: { "User-Agent": "BoothPulseAI/4.0" } },
          );
          const data = await response.json();

          if (data.length > 0) {
            resolvedCoordinates = {
              lat: parseFloat(data[0].lat),
              lon: parseFloat(data[0].lon),
            };
            statusDiv.className =
              "text-xs text-center py-2 rounded-lg bg-emerald-500/20 text-emerald-400";
            statusDiv.textContent = `âœ“ Coordinates resolved: ${resolvedCoordinates.lat.toFixed(4)}, ${resolvedCoordinates.lon.toFixed(4)}`;
          } else {
            statusDiv.className =
              "text-xs text-center py-2 rounded-lg bg-yellow-500/20 text-yellow-400";
            statusDiv.textContent =
              "Location not found. Using city coordinates.";
            resolvedCoordinates = null;
          }
        } catch (error) {
          statusDiv.className =
            "text-xs text-center py-2 rounded-lg bg-red-500/20 text-red-400";
          statusDiv.textContent =
            "Error resolving location. Will use city coordinates.";
          resolvedCoordinates = null;
        }
      }

      // ==================== FORM SUBMISSION ====================
      document
        .getElementById("feedback-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const text = document.getElementById("feedback-text").value.trim();
          if (!text) {
            showNotification("Please enter feedback text", "warning");
            return;
          }

          const submitBtn = document.getElementById("submit-btn");
          const submitText = document.getElementById("submit-text");
          const submitSpinner = document.getElementById("submit-spinner");

          // Show loading state
          submitBtn.disabled = true;
          submitText.textContent = "Analyzing...";
          submitSpinner.classList.remove("hidden");

          try {
            const payload = {
              text: text,
              country:
                document.getElementById("country-select").value || "India",
              state: document.getElementById("state-select").value || "",
              city: document.getElementById("city-select").value || "",
              street: document.getElementById("street-input").value || null,
              landmark: document.getElementById("landmark-input").value || null,
              ward: document.getElementById("ward-input").value || null,
              booth_number:
                document.getElementById("booth-input").value || null,
              lat: resolvedCoordinates?.lat || null,
              lon: resolvedCoordinates?.lon || null,
            };

            const response = await fetch("/analyze", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            const result = await response.json();

            if (result.success) {
              displayResult(result.data);

              // Clear form
              document.getElementById("feedback-text").value = "";
              resolvedCoordinates = null;

              // Refresh dashboard
              loadDashboardData();
              loadAlerts();
              loadAISummary();

              // Show alert notification if triggered
              if (result.alert_triggered) {
                showNotification(
                  "ðŸš¨ Alert triggered for this location!",
                  "warning",
                );
              }
            }
          } catch (error) {
            console.error("Error:", error);
            showNotification("Error analyzing feedback", "error");
          } finally {
            // Reset button
            submitBtn.disabled = false;
            submitText.textContent = "Analyze Sentiment";
            submitSpinner.classList.add("hidden");
          }
        });

      function displayResult(data) {
        const container = document.getElementById("result-container");
        const card = document.getElementById("result-card");
        const sentiment = document.getElementById("result-sentiment");
        const confidence = document.getElementById("result-confidence");
        const issue = document.getElementById("result-issue");
        const location = document.getElementById("result-location");
        const time = document.getElementById("result-time");

        // Set sentiment styling
        if (data.sentiment === "positive") {
          card.className = "rounded-xl p-4 text-white badge-positive";
          sentiment.className =
            "text-lg font-bold uppercase px-3 py-1 rounded-lg bg-white/20";
        } else if (data.sentiment === "negative") {
          card.className = "rounded-xl p-4 text-white badge-negative";
          sentiment.className =
            "text-lg font-bold uppercase px-3 py-1 rounded-lg bg-white/20";
        } else {
          card.className = "rounded-xl p-4 text-white badge-neutral";
          sentiment.className =
            "text-lg font-bold uppercase px-3 py-1 rounded-lg bg-white/20";
        }

        sentiment.textContent = data.sentiment;
        confidence.textContent = `${(data.confidence * 100).toFixed(1)}% confidence`;
        issue.textContent = data.issue;
        location.textContent = `${data.city}, ${data.state}`;
        time.textContent = data.timestamp;

        container.classList.remove("hidden");
      }

      // ==================== DASHBOARD DATA ====================
      async function loadDashboardData() {
        try {
          const response = await fetch(
            `/dashboard-data?time_range=${currentTimeRange}`,
          );
          const data = await response.json();

          // Update stats
          document.getElementById("total-feedback").textContent =
            data.total_feedback;
          document.getElementById("db-entries").textContent =
            data.database_entries || data.total_feedback;
          document.getElementById("positive-pct").textContent =
            `${data.positive_pct}%`;
          document.getElementById("negative-pct").textContent =
            `${data.negative_pct}%`;
          document.getElementById("neutral-pct").textContent =
            `${data.neutral_pct}%`;
          document.getElementById("risk-index-value").textContent =
            data.risk_index;

          // Update risk index color and card glow
          const riskEl = document.getElementById("risk-index-value");
          const riskCard = document.getElementById("risk-card");
          if (data.risk_index < 30) {
            riskEl.className = "text-3xl font-bold text-emerald-400 mt-1";
            riskCard.classList.remove("critical-glow");
          } else if (data.risk_index < 60) {
            riskEl.className = "text-3xl font-bold text-yellow-400 mt-1";
            riskCard.classList.remove("critical-glow");
          } else {
            riskEl.className = "text-3xl font-bold text-red-400 mt-1";
            riskCard.classList.add("critical-glow");
          }

          // Update momentum
          updateMomentum(data.momentum);

          // Update gauge
          updateGauge(data.risk_index);

          // Update early warning
          const warningBadge = document.getElementById("early-warning-badge");
          if (data.early_warning) {
            warningBadge.classList.remove("hidden");
          } else {
            warningBadge.classList.add("hidden");
          }

          // Update activity feed
          updateActivityFeed(data.recent_activity);

          // Update charts
          updateTimelineChart(data.timeline_data);
          updateIssueChart(data.issue_distribution);
          updateSentimentChart(data.sentiment_distribution);

          // Update map
          updateMap(data.geo_data);

          // Update city stats (risk leaderboard)
          updateCityStats(data.city_stats);

          // Update governance actions
          updateGovernanceActions(data.governance_actions);

          // Update anomalies in alert center
          updateAnomalies(data.anomalies);
        } catch (error) {
          console.error("Error loading dashboard data:", error);
        }
      }

      function updateMomentum(momentum) {
        const arrow = document.getElementById("momentum-arrow");
        const value = document.getElementById("momentum-value");
        const icon = document.getElementById("momentum-icon");
        const iconContainer = document.getElementById(
          "momentum-icon-container",
        );

        if (!momentum.has_data) {
          arrow.textContent = "â†’";
          arrow.className = "text-2xl text-slate-400";
          value.textContent = "Pending";
          value.className = "text-xl font-bold text-slate-400";
          iconContainer.className =
            "w-12 h-12 rounded-xl bg-slate-500/20 flex items-center justify-center flex-shrink-0";
          icon.className = "w-6 h-6 text-slate-400";
          return;
        }

        if (momentum.direction === "improving") {
          arrow.textContent = "ðŸ“ˆ";
          arrow.className = "text-2xl bounce-up";
          value.textContent = `+${Math.abs(momentum.change)}%`;
          value.className = "text-xl font-bold text-emerald-400";
          iconContainer.className =
            "w-12 h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center flex-shrink-0";
          icon.className = "w-6 h-6 text-emerald-400";
        } else if (momentum.direction === "declining") {
          arrow.textContent = "ðŸ“‰";
          arrow.className = "text-2xl bounce-down";
          value.textContent = `${momentum.change}%`;
          value.className = "text-xl font-bold text-red-400";
          iconContainer.className =
            "w-12 h-12 rounded-xl bg-red-500/20 flex items-center justify-center flex-shrink-0";
          icon.className = "w-6 h-6 text-red-400";
        } else {
          arrow.textContent = "â†’";
          arrow.className = "text-2xl text-slate-400";
          value.textContent = "Stable";
          value.className = "text-xl font-bold text-slate-400";
          iconContainer.className =
            "w-12 h-12 rounded-xl bg-slate-500/20 flex items-center justify-center flex-shrink-0";
          icon.className = "w-6 h-6 text-slate-400";
        }
      }

      function updateGovernanceActions(actions) {
        const container = document.getElementById("governance-actions");
        const engineCard = document.getElementById("governance-engine");

        if (!actions || actions.length === 0) {
          container.innerHTML = `
            <div class="text-center py-8 text-slate-500 italic">
              <p>No governance actions required at this time.</p>
              <p class="text-xs mt-2">Actions will appear when issue thresholds are exceeded.</p>
            </div>
          `;
          engineCard.classList.remove("critical-glow");
          return;
        }

        // Add glow if there are high urgency actions
        if (actions.some((a) => a.urgency === "High")) {
          engineCard.classList.add("critical-glow");
        } else {
          engineCard.classList.remove("critical-glow");
        }

        container.innerHTML = actions
          .map((action, index) => {
            const urgencyColor =
              action.urgency === "High"
                ? "red"
                : action.urgency === "Medium"
                  ? "yellow"
                  : "emerald";
            const riskColor =
              action.risk_level === "Critical"
                ? "red"
                : action.risk_level === "Elevated"
                  ? "yellow"
                  : "emerald";

            return `
            <div class="bg-slate-700/30 rounded-xl p-4 border border-slate-600/50 hover:border-${urgencyColor}-500/50 transition-all duration-200 fade-in" style="animation-delay: ${index * 0.1}s">
              <div class="flex items-start justify-between gap-4 mb-3">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="px-2 py-1 text-xs font-semibold rounded bg-${urgencyColor}-500/20 text-${urgencyColor}-400">${action.urgency} Urgency</span>
                    <span class="px-2 py-1 text-xs font-semibold rounded bg-${riskColor}-500/20 text-${riskColor}-400">${action.risk_level}</span>
                  </div>
                  <h4 class="font-semibold text-white">${action.situation}</h4>
                </div>
              </div>
              <div class="space-y-2 text-sm">
                <div class="flex items-start gap-2">
                  <span class="text-slate-500 min-w-[100px]">Key Issue:</span>
                  <span class="text-slate-300">${action.key_issue}</span>
                </div>
                <div class="flex items-start gap-2">
                  <span class="text-slate-500 min-w-[100px]">Action:</span>
                  <span class="text-emerald-400 font-medium">${action.recommended_action}</span>
                </div>
                <div class="flex items-start gap-2">
                  <span class="text-slate-500 min-w-[100px]">Department:</span>
                  <span class="text-blue-400">${action.department}</span>
                </div>
              </div>
            </div>
          `;
          })
          .join("");
      }

      function updateAnomalies(anomalies) {
        if (anomalies && anomalies.length > 0) {
          anomalies.forEach((anomaly) => {
            if (anomaly.severity === "high") {
              showNotification(anomaly.message, "warning");
            }
          });
        }
      }

      function updateGauge(value) {
        const gaugeFill = document.getElementById("gauge-fill");
        const gaugeValue = document.getElementById("gauge-value");

        // Calculate stroke offset (251.2 is the full arc length)
        const offset = 251.2 - (value / 100) * 251.2;
        gaugeFill.style.strokeDashoffset = offset;

        // Set color based on value
        if (value < 30) {
          gaugeFill.style.stroke = "#10b981";
        } else if (value < 60) {
          gaugeFill.style.stroke = "#f59e0b";
        } else {
          gaugeFill.style.stroke = "#ef4444";
        }

        gaugeValue.textContent = value;
      }

      function updateActivityFeed(activities) {
        const feed = document.getElementById("activity-feed");

        if (!activities || activities.length === 0) {
          feed.innerHTML =
            '<p class="text-slate-500 italic text-center py-8">No feedback submitted yet. Start by submitting your first feedback!</p>';
          return;
        }

        feed.innerHTML = activities
          .map((activity) => {
            const badgeClass =
              activity.sentiment === "positive"
                ? "badge-positive"
                : activity.sentiment === "negative"
                  ? "badge-negative"
                  : "badge-neutral";
            return `
            <div class="bg-slate-700/30 rounded-xl p-4 border border-slate-600/50 slide-in-right hover:bg-slate-700/50 transition-all duration-200">
              <div class="flex items-start justify-between gap-4">
                <div class="flex-1">
                  <p class="text-sm text-slate-300 line-clamp-2">${escapeHtml(activity.text)}</p>
                  <div class="flex items-center gap-3 mt-2 text-xs text-slate-500">
                    <span>${activity.city || "Unknown"}</span>
                    <span>â€¢</span>
                    <span>${activity.issue}</span>
                    <span>â€¢</span>
                    <span>${activity.timestamp}</span>
                  </div>
                </div>
                <span class="${badgeClass} px-2 py-1 rounded text-xs font-semibold uppercase flex-shrink-0">${activity.sentiment}</span>
              </div>
            </div>
          `;
          })
          .join("");
      }

      function updateCityStats(stats) {
        const tbody = document.getElementById("city-stats-body");

        if (!stats || stats.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="text-center py-8 text-slate-500 italic">No city data available</td></tr>';
          return;
        }

        tbody.innerHTML = stats
          .map((city, index) => {
            const riskScore = city.risk_score || 0;
            let statusBadge, statusClass;

            if (riskScore <= 30) {
              statusBadge = "ðŸŸ¢ Stable";
              statusClass = "text-emerald-400 bg-emerald-500/20";
            } else if (riskScore <= 60) {
              statusBadge = "ðŸŸ¡ Watchlist";
              statusClass = "text-yellow-400 bg-yellow-500/20 status-watchlist";
            } else {
              statusBadge = "ðŸ”´ Critical";
              statusClass = "text-red-400 bg-red-500/20 status-critical";
            }

            const riskColor =
              riskScore > 60
                ? "text-red-400"
                : riskScore > 30
                  ? "text-yellow-400"
                  : "text-emerald-400";

            return `
            <tr class="border-b border-slate-600/30 table-row-striped cursor-pointer hover:bg-slate-700/40 transition-all duration-200" onclick="zoomToCity('${city.city}')">
              <td class="px-4 py-3 font-bold text-blue-400">#${index + 1}</td>
              <td class="px-4 py-3 font-medium text-white">${city.city}</td>
              <td class="px-4 py-3 text-center">
                <span class="text-xl font-bold ${riskColor}">${riskScore}</span>
              </td>
              <td class="px-4 py-3 text-center">
                <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusClass}">${statusBadge}</span>
              </td>
              <td class="px-4 py-3 text-center text-slate-300">${city.total}</td>
              <td class="px-4 py-3 text-center text-red-400 font-semibold">${city.negative_ratio}%</td>
            </tr>
          `;
          })
          .join("");
      }

      // ==================== MAP FUNCTIONS ====================
      function initMap() {
        map = L.map("map").setView([20.5937, 78.9629], 5);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap contributors",
        }).addTo(map);

        markerCluster = L.markerClusterGroup({
          spiderfyOnMaxZoom: true,
          showCoverageOnHover: false,
          maxClusterRadius: 50,
        });

        map.addLayer(markerCluster);
      }

      function updateMap(geoData) {
        if (!map || !markerCluster) return;

        markerCluster.clearLayers();
        cityMarkers = {};

        if (!geoData || geoData.length === 0) return;

        geoData.forEach((point) => {
          const color =
            point.sentiment === "positive"
              ? "#10b981"
              : point.sentiment === "negative"
                ? "#ef4444"
                : "#6b7280";
          const radius = 8 + point.confidence * 12;

          const marker = L.circleMarker([point.lat, point.lon], {
            radius: radius,
            fillColor: color,
            color: color,
            weight: 2,
            opacity: 0.8,
            fillOpacity: 0.6,
          });

          marker.bindPopup(`
            <div class="text-sm p-2">
              <strong class="text-lg">${point.city || "Unknown"}</strong><br>
              <span style="color: ${color}; font-weight: bold;">${point.sentiment.toUpperCase()}</span><br>
              <hr class="my-2 border-gray-300">
              Issue: ${point.issue}<br>
              Confidence: ${(point.confidence * 100).toFixed(1)}%
            </div>
          `);

          markerCluster.addLayer(marker);

          // Track city markers for drill-down
          const cityKey = (point.city || "Unknown").toLowerCase();
          if (!cityMarkers[cityKey]) {
            cityMarkers[cityKey] = {
              lat: point.lat,
              lon: point.lon,
              markers: [],
            };
          }
          cityMarkers[cityKey].markers.push(marker);
        });
      }

      function zoomToCity(cityName) {
        if (!map) return;

        const cityKey = cityName.toLowerCase();
        const cityData = cityMarkers[cityKey];

        if (cityData) {
          map.setView([cityData.lat, cityData.lon], 12, { animate: true });
          showNotification(`Zoomed to ${cityName}`, "info");

          setTimeout(() => {
            if (markerCluster && cityData.markers.length > 0) {
              const firstMarker = cityData.markers[0];
              firstMarker.openPopup();
            }
          }, 500);
        } else {
          showNotification(`No data available for ${cityName}`, "warning");
        }
      }

      // ==================== CHART FUNCTIONS ====================
      function initCharts() {
        // Timeline Chart
        const timelineCtx = document
          .getElementById("timeline-chart")
          .getContext("2d");
        timelineChart = new Chart(timelineCtx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Sentiment Score",
                data: [],
                borderColor: "#3b82f6",
                backgroundColor: "rgba(59, 130, 246, 0.1)",
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: "#3b82f6",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { display: false },
              y: {
                min: -1,
                max: 1,
                grid: { color: "rgba(255,255,255,0.05)" },
                ticks: { color: "#6b7280" },
              },
            },
          },
        });

        // Issue Chart
        const issueCtx = document
          .getElementById("issue-chart")
          .getContext("2d");
        issueChart = new Chart(issueCtx, {
          type: "bar",
          data: {
            labels: [
              "Water",
              "Roads",
              "Employment",
              "Healthcare",
              "Education",
              "General",
            ],
            datasets: [
              {
                data: [0, 0, 0, 0, 0, 0],
                backgroundColor: [
                  "rgba(59, 130, 246, 0.8)",
                  "rgba(249, 115, 22, 0.8)",
                  "rgba(16, 185, 129, 0.8)",
                  "rgba(239, 68, 68, 0.8)",
                  "rgba(168, 85, 247, 0.8)",
                  "rgba(107, 114, 128, 0.8)",
                ],
                borderRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: {
                grid: { display: false },
                ticks: { color: "#6b7280", font: { size: 10 } },
              },
              y: {
                grid: { color: "rgba(255,255,255,0.05)" },
                ticks: { color: "#6b7280" },
              },
            },
          },
        });

        // Sentiment Chart
        const sentimentCtx = document
          .getElementById("sentiment-chart")
          .getContext("2d");
        sentimentChart = new Chart(sentimentCtx, {
          type: "doughnut",
          data: {
            labels: ["Positive", "Negative", "Neutral"],
            datasets: [
              {
                data: [0, 0, 0],
                backgroundColor: [
                  "rgba(16, 185, 129, 0.8)",
                  "rgba(239, 68, 68, 0.8)",
                  "rgba(107, 114, 128, 0.8)",
                ],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: { color: "#9ca3af", padding: 15, usePointStyle: true },
              },
            },
            cutout: "65%",
          },
        });
      }

      function updateTimelineChart(data) {
        if (!timelineChart || !data) return;

        const labels = data.map((_, i) => `#${i + 1}`);
        const scores = data.map((d) => d.score);
        const colors = data.map((d) =>
          d.sentiment === "positive"
            ? "#10b981"
            : d.sentiment === "negative"
              ? "#ef4444"
              : "#6b7280",
        );

        timelineChart.data.labels = labels;
        timelineChart.data.datasets[0].data = scores;
        timelineChart.data.datasets[0].pointBackgroundColor = colors;
        timelineChart.update();
      }

      function updateIssueChart(data) {
        if (!issueChart || !data) return;

        issueChart.data.datasets[0].data = [
          data.Water || 0,
          data.Roads || 0,
          data.Employment || 0,
          data.Healthcare || 0,
          data.Education || 0,
          data.General || 0,
        ];
        issueChart.update();
      }

      function updateSentimentChart(data) {
        if (!sentimentChart || !data) return;

        sentimentChart.data.datasets[0].data = [
          data.positive || 0,
          data.negative || 0,
          data.neutral || 0,
        ];
        sentimentChart.update();
      }

      // ==================== ALERTS ====================
      async function loadAlerts() {
        try {
          const response = await fetch("/alerts");
          const data = await response.json();

          // Update badge
          const badge = document.getElementById("alert-badge");
          if (data.unacknowledged > 0) {
            badge.textContent = data.unacknowledged;
            badge.classList.remove("hidden");
          } else {
            badge.classList.add("hidden");
          }

          // Update alert counts
          document.getElementById("alert-high").textContent =
            data.high_severity;
          document.getElementById("alert-medium").textContent =
            data.medium_severity;
          document.getElementById("alert-low").textContent = data.low_severity;

          // Update alert list
          const alertList = document.getElementById("alert-list");

          if (!data.alerts || data.alerts.length === 0) {
            alertList.innerHTML =
              '<p class="text-slate-500 italic text-center py-8">No alerts yet</p>';
            return;
          }

          alertList.innerHTML = data.alerts
            .map(
              (alert) => `
            <div class="alert-${alert.severity} rounded-xl p-4 slide-in-right">
              <div class="flex items-start gap-3">
                <div class="w-8 h-8 rounded-lg ${alert.severity === "high" ? "bg-red-500/20" : alert.severity === "medium" ? "bg-yellow-500/20" : "bg-emerald-500/20"} flex items-center justify-center flex-shrink-0">
                  <svg class="w-4 h-4 ${alert.severity === "high" ? "text-red-400" : alert.severity === "medium" ? "text-yellow-400" : "text-emerald-400"}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                  </svg>
                </div>
                <div class="flex-1">
                  <p class="text-sm font-semibold text-white">${alert.message}</p>
                  <p class="text-xs text-slate-400 mt-1">${alert.detail}</p>
                  <p class="text-xs text-slate-500 mt-2">${alert.timestamp}</p>
                </div>
              </div>
            </div>
          `,
            )
            .join("");
        } catch (error) {
          console.error("Error loading alerts:", error);
        }
      }

      function toggleAlertCenter() {
        const alertCenter = document.getElementById("alert-center");
        const overlay = document.getElementById("alert-overlay");

        if (alertCenter.classList.contains("translate-x-full")) {
          alertCenter.classList.remove("translate-x-full");
          overlay.classList.remove("hidden");
        } else {
          alertCenter.classList.add("translate-x-full");
          overlay.classList.add("hidden");
        }
      }

      // ==================== AI SUMMARY ====================
      async function loadAISummary() {
        try {
          const response = await fetch("/ai-summary");
          const data = await response.json();

          const summaryDiv = document.getElementById("ai-summary");

          if (data.total_feedback === 0) {
            summaryDiv.innerHTML =
              '<p class="text-slate-500 italic">No analysis data yet. Submit feedback to generate intelligence insights.</p>';
            return;
          }

          const s = data.structured_summary;

          summaryDiv.innerHTML = `
            <div class="space-y-4">
              <div class="flex items-start gap-3">
                <span class="text-lg">ðŸ“Š</span>
                <div>
                  <span class="text-slate-500 text-xs font-medium uppercase tracking-wider">Situation</span>
                  <p class="text-slate-300 mt-1">${escapeHtml(s.situation)}</p>
                </div>
              </div>
              
              <div class="flex items-start gap-3">
                <span class="text-lg">ðŸŽ¯</span>
                <div>
                  <span class="text-slate-500 text-xs font-medium uppercase tracking-wider">Key Issue</span>
                  <p class="text-white font-semibold mt-1">${escapeHtml(s.dominant_issue)}</p>
                </div>
              </div>
              
              <div class="flex items-start gap-3">
                <span class="text-lg">${s.trend === "Improving" ? "ðŸ“ˆ" : s.trend === "Declining" ? "ðŸ“‰" : "âž¡ï¸"}</span>
                <div>
                  <span class="text-slate-500 text-xs font-medium uppercase tracking-wider">Trend</span>
                  <p class="mt-1 ${s.trend === "Improving" ? "text-emerald-400" : s.trend === "Declining" ? "text-red-400" : "text-slate-400"} font-semibold">${escapeHtml(s.trend)}</p>
                </div>
              </div>
              
              <div class="flex items-start gap-3">
                <span class="text-lg">${s.risk_zone.includes("Critical") ? "ðŸš¨" : s.risk_zone.includes("Elevated") ? "âš ï¸" : "âœ…"}</span>
                <div>
                  <span class="text-slate-500 text-xs font-medium uppercase tracking-wider">Risk Zone</span>
                  <p class="mt-1 ${s.risk_zone.includes("Critical") ? "text-red-400" : s.risk_zone.includes("Elevated") ? "text-yellow-400" : "text-emerald-400"} font-semibold">${escapeHtml(s.risk_zone)}</p>
                </div>
              </div>
              
              <div class="flex items-start gap-3 bg-blue-500/10 rounded-lg p-3 border border-blue-500/30">
                <span class="text-lg">âš¡</span>
                <div>
                  <span class="text-blue-400 text-xs font-medium uppercase tracking-wider">Recommended Action</span>
                  <p class="text-white mt-1 font-medium">${escapeHtml(s.action)}</p>
                </div>
              </div>
              
              <div class="flex items-center justify-between pt-2 border-t border-slate-600/50 mt-4">
                <span class="text-slate-500 text-xs">Analysis Confidence</span>
                <div class="flex items-center gap-2">
                  <div class="w-24 h-2 bg-slate-700 rounded-full overflow-hidden">
                    <div class="h-full bg-blue-500 rounded-full transition-all duration-500" style="width: ${s.confidence}%"></div>
                  </div>
                  <span class="text-blue-400 font-semibold text-sm">${s.confidence}%</span>
                </div>
              </div>
            </div>
          `;
        } catch (error) {
          console.error("Error loading AI summary:", error);
        }
      }

      // ==================== UTILITIES ====================
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-xl shadow-lg z-50 fade-in font-medium ${
          type === "warning"
            ? "bg-yellow-500/90 text-yellow-900"
            : type === "error"
              ? "bg-red-500/90 text-white"
              : "bg-blue-500/90 text-white"
        }`;
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 4000);
      }
    </script>
  </body>
</html>
